<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Authenticating...</title>
    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-5FBJMJQG');</script>
    <!-- End Google Tag Manager -->
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5FBJMJQG" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <script>
        (function () {
            // Get params from URL
            const params = new URLSearchParams(window.location.search);
            const eventName = params.get('event');
            const userId = params.get('user_id');

            if (eventName) {
                // Prepare event data
                const eventData = {
                    event: eventName,
                    timestamp: new Date().toISOString(),
                    source: 'extension_bridge'
                };

                if (userId) {
                    eventData.user_id = userId;
                }

                // Push to GTM
                window.dataLayer = window.dataLayer || [];
                window.dataLayer.push(eventData);
                console.log('Event pushed:', eventData);

                // Close window after a short delay to ensure GTM fires
                setTimeout(() => {
                    // Try to close the tab
                    window.close();

                    // Fallback UI
                    document.body.innerHTML = '<div style="font-family:sans-serif;text-align:center;padding:50px;">Authentication tracked. You can close this tab.</div>';
                }, 2000);
            } else {
                window.close();
            }
        })();
    </script>
</body>

</html>