<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Success</title>
    <!-- Version: 3.0.0 (Ultra-Premium Glassmorphism) -->

    <!-- Ultra-Optimized Inline Styles (No Requests = Blazing Fast) -->
    <style>
        :root {
            /* Base Variables */
            --font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --text-primary: #111827;
            --text-secondary: #4b5563;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: var(--font-family);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #ffffff;
            /* Fallback */
            overflow: hidden;
            /* For background blobs */
        }

        /* Animated Background Mesh */
        .bg-mesh {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 0% 0%, #e0f2fe 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, #fef3c7 0%, transparent 50%);
            opacity: 0;
            transition: opacity 1s ease;
        }

        /* Theme Gradients */
        body.theme-purchase .bg-mesh {
            opacity: 1;
            background: linear-gradient(135deg, #FFEFBA 0%, #FFFFFF 100%);
            /* Complex mesh fallback to simple gradient for speed */
            background: radial-gradient(closest-corner at 20% 20%, rgba(255, 215, 0, 0.2) 0%, transparent 70%),
                radial-gradient(closest-corner at 80% 80%, rgba(255, 100, 0, 0.1) 0%, transparent 70%),
                #fffbeb;
        }

        body.theme-signup .bg-mesh {
            opacity: 1;
            background: radial-gradient(closest-corner at 30% 30%, rgba(59, 130, 246, 0.15) 0%, transparent 70%),
                radial-gradient(closest-corner at 70% 70%, rgba(139, 92, 246, 0.1) 0%, transparent 70%),
                #f0f9ff;
        }

        /* Glass Card */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: 24px;
            padding: 48px 40px;
            text-align: center;
            max-width: 420px;
            width: 100%;
            position: relative;
            transform: translateY(30px) scale(0.95);
            opacity: 0;
            animation: popIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes popIn {
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        /* Icons */
        .icon-container {
            width: 96px;
            height: 96px;
            margin: 0 auto 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .icon-svg {
            width: 48px;
            height: 48px;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            animation: drawCheck 1s cubic-bezier(0.16, 1, 0.3, 1) 0.3s forwards;
        }

        .theme-purchase .icon-svg {
            stroke: #d97706;
        }

        /* Gold-ish */
        .theme-signup .icon-svg {
            stroke: #2563eb;
        }

        /* Blue */

        @keyframes drawCheck {
            to {
                stroke-dashoffset: 0;
            }
        }

        /* Typography */
        h1 {
            color: var(--text-primary);
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin: 0 0 16px;
            line-height: 1.1;
        }

        p {
            color: var(--text-secondary);
            font-size: 17px;
            line-height: 1.6;
            margin: 0 0 32px;
        }

        /* Status Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 99px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--text-primary);
            border-radius: 50%;
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }

        .badge.done .spinner {
            animation: none;
            border-color: #10b981;
            background: #10b981;
            width: 10px;
            height: 10px;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        /* Button */
        button {
            background: var(--text-primary);
            color: #fff;
            border: none;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        button:active {
            transform: translateY(0);
        }

        .hidden {
            display: none;
        }
    </style>

    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-5FBJMJQG');</script>
    <!-- End Google Tag Manager -->
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5FBJMJQG" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <!-- Animated Mesh Background -->
    <div class="bg-mesh"></div>

    <div class="card">
        <div class="icon-container">
            <!-- Check Icon (Default) -->
            <svg class="icon-svg" id="icon-home" viewBox="0 0 24 24">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            <!-- Star Icon (Premium) -->
            <svg class="icon-svg hidden" id="icon-premium" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                <!-- Using stroke for animation consistency, swapped to path -->
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
        </div>

        <h1 id="ui-title">Processing...</h1>
        <p id="ui-desc">Confirming your details.</p>

        <div class="badge" id="status-badge">
            <div class="spinner"></div>
            <span id="status-text">Syncing...</span>
        </div>

        <button id="close-btn" class="hidden" onclick="window.close()">Close Window</button>
    </div>

    <script>
        (function () {
            // --- UI CONTROL ---
            const ui = {
                title: document.getElementById('ui-title'),
                desc: document.getElementById('ui-desc'),
                body: document.body,
                iconHome: document.getElementById('icon-home'),
                iconPremium: document.getElementById('icon-premium'),
                badge: document.getElementById('status-badge'),
                statusText: document.getElementById('status-text'),
                btn: document.getElementById('close-btn')
            };

            const params = new URLSearchParams(window.location.search);
            const eventName = params.get('event');
            const extensionId = params.get('extension_id');
            const sessionId = params.get('session_id') || params.get('transaction_id');

            // 1. INSTANT THEME RENDER
            if (eventName === 'purchase') {
                ui.body.classList.add('theme-purchase');
                ui.title.textContent = "Premium Unlocked";
                ui.desc.textContent = "Thank you! Your account has been upgraded successfully.";
                ui.iconHome.classList.add('hidden');
                ui.iconPremium.classList.remove('hidden');
                ui.iconPremium.style.stroke = "#d97706";
            } else if (eventName === 'sign_up') {
                ui.body.classList.add('theme-signup');
                ui.title.textContent = "Welcome Aboard";
                ui.desc.textContent = "Your account is active. You can close this window.";
            } else {
                ui.body.classList.add('theme-signup'); // Default fallback
                ui.title.textContent = "Success";
                ui.desc.textContent = "Operation completed.";
            }

            // --- BUSINESS LOGIC ---
            function markDone(success = true) {
                if (success) {
                    ui.badge.classList.add('done');
                    ui.statusText.textContent = "Complete";
                    setTimeout(() => {
                        ui.badge.style.display = 'none'; // Clean up
                        ui.btn.classList.remove('hidden');
                    }, 500);
                } else {
                    ui.statusText.textContent = "Error";
                    ui.statusText.style.color = "red";
                }
            }

            try {
                // 1. BEACON (Extension)
                if (extensionId && sessionId) {
                    if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.sendMessage) {
                        chrome.runtime.sendMessage(extensionId, { type: 'payment-success', sessionId: sessionId },
                            (r) => { if (chrome.runtime.lastError) console.warn('Polling fallback'); }
                        );
                    }
                }

                // 2. GTM
                if (eventName) {
                    const secret = params.get('s');
                    if (secret !== 'inf_sec_882') {
                        ui.title.textContent = "Security Check Failed";
                        markDone(false);
                        return;
                    }

                    window.dataLayer = window.dataLayer || [];
                    if (eventName === 'purchase') {
                        window.dataLayer.push({
                            event: 'purchase',
                            ecommerce: {
                                transaction_id: params.get('transaction_id'),
                                value: parseFloat(params.get('value')),
                                currency: params.get('currency'),
                                items: [{ item_name: params.get('item_name'), price: parseFloat(params.get('value')), quantity: 1 }]
                            }
                        });
                    } else {
                        window.dataLayer.push({ event: eventName, user_id: params.get('user_id'), timestamp: new Date().toISOString() });
                    }

                    // Auto Close Attempt
                    setTimeout(() => {
                        window.close();
                        markDone(true);
                    }, 1200);
                } else {
                    // No event? Just show success if we have extension params
                    if (extensionId) markDone(true);
                }

            } catch (e) {
                console.error(e);
                ui.desc.textContent = "Error: " + e.message;
                markDone(false);
            }
        })();
    </script>
</body>

</html>